<!-- Button triggers for different transaction types -->
<div class="d-flex gap-2 mb-4">
  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#depositModal">
    <i class="bi bi-cash-coin me-2"></i> Make Deposit
  </button>

  <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#withdrawalModal">
    <i class="bi bi-arrow-up-circle me-2"></i> Request Withdrawal
  </button>
</div>

<!-- Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="depositModalLabel">
          <i class="bi bi-cash-stack me-2"></i> Orange Money Deposit
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <!-- Information Column -->
          <div class="col-md-5">
            <div class="card border-0 h-100">
              <div class="card-body">
                <h5 class="card-title text-success">
                  <i class="bi bi-info-circle me-2"></i>Deposit Information
                </h5>

                <ul class="list-group list-group-flush">
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-currency-exchange text-success me-2"></i>
                    <strong>Minimum deposit:</strong> 100 XAF
                  </li>
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-lightning-charge text-success me-2"></i>
                    <strong>Processing time:</strong> Instant
                  </li>
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-shield-lock text-success me-2"></i>
                    <strong>Secure</strong> payment processing
                  </li>
                </ul>

                <div class="alert alert-success mt-3">
                  <i class="bi bi-check-circle me-2"></i>
                  No deposit fees charged
                </div>
              </div>
            </div>
          </div>

          <!-- Form Column -->
          <div class="col-md-7">
            <%= form_with url: orange_money_deposit_wallet_transactions_path(@wallet),
                          method: :post,
                          html: { class: 'needs-validation', novalidate: true } do |f| %>

              <div class="mb-3">
                <%= f.label :amount, 'Amount (XAF)', class: 'form-label fw-bold' %>
                <div class="input-group">
                  <span class="input-group-text bg-light">XAF</span>
                  <%= f.number_field :amount,
                      class: 'form-control form-control-lg',
                      min: 100,
                      step: 100,
                      required: true,
                      placeholder: '1000',
                      oninput: "this.value = Math.abs(this.value)" %>
                </div>
                <div class="invalid-feedback">
                  Please enter a valid amount (minimum 100 XAF)
                </div>
              </div>

              <div class="mb-4">
                <%= f.label :phone_number, 'Orange Money Number', class: 'form-label fw-bold' %>
                <div class="input-group">
                  <span class="input-group-text bg-light">+237</span>
                  <%= f.telephone_field :phone_number,
                      class: 'form-control form-control-lg',
                      required: true,
                      placeholder: '6XXXXXXXX',
                      pattern: '^[6-9]\d{8}$',
                      title: 'Enter 9-digit Orange Money number' %>
                </div>
                <div class="invalid-feedback">
                  Please enter a valid Orange Money number
                </div>
              </div>

              <div class="d-grid">
                <%= f.submit 'Initiate Deposit',
                    class: 'btn btn-success btn-lg py-3 fw-bold',
                    data: { disable_with: '<i class="bi bi-arrow-repeat spin me-2"></i> Processing...' } %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <small class="text-muted me-auto">
          <i class="bi bi-shield-lock me-1"></i>Secured by Orange Money
        </small>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Withdrawal Modal -->
<div class="modal fade" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="withdrawalModalLabel">
          <i class="bi bi-arrow-up-circle me-2"></i> Request Withdrawal
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <!-- Information Column -->
          <div class="col-md-5">
            <div class="card border-0 h-100">
              <div class="card-body">
                <h5 class="card-title text-warning">
                  <i class="bi bi-info-circle me-2"></i>Withdrawal Details
                </h5>

                <ul class="list-group list-group-flush mb-3">
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-clock text-warning me-2"></i>
                    <strong>Processing Time:</strong> 1-3 business days
                  </li>
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-percent text-warning me-2"></i>
                    <strong>Fees:</strong> 1% (min. 100 XAF)
                  </li>
                  <li class="list-group-item border-0 px-0">
                    <i class="bi bi-currency-exchange text-warning me-2"></i>
                    <strong>Minimum:</strong> 1,000 XAF
                  </li>
                </ul>

                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Verify your phone number before withdrawal
                </div>
              </div>
            </div>
          </div>

          <!-- Form Column -->
          <div class="col-md-7">
            <%= simple_form_for [@wallet, @transaction],
                               html: {
                                 class: 'needs-validation',
                                 novalidate: true,
                                 id: 'withdrawalForm'
                               } do |f| %>

              <div class="mb-3">
                <%= f.label :amount, 'Amount (XAF)', class: 'form-label fw-bold' %>
                <div class="input-group">
                  <span class="input-group-text bg-light">XAF</span>
                  <%= f.number_field :amount,
                      class: 'form-control form-control-lg',
                      min: 1000,
                      max: @wallet.balance,
                      step: 100,
                      required: true,
                      placeholder: '1000',
                      id: 'withdrawalAmount',
                      oninput: "this.value = Math.abs(this.value)" %>
                </div>
                <small class="text-muted">
                  Available: <%= number_to_currency(@wallet.balance, unit: 'XAF') %>
                </small>
                <div class="invalid-feedback">
                  Please enter a valid amount between 1,000 XAF and <%= number_to_currency(@wallet.balance, unit: 'XAF') %>
                </div>
              </div>

              <div class="mb-3">
                <%= f.label :payment_method, 'Withdrawal Method', class: 'form-label fw-bold' %>
                <%= f.select :payment_method,
                    options_for_select(
                      [
                        ['Orange Money', 'orange_money', { 'data-icon': 'bi-phone' }],
                        ['MTN Mobile Money', 'mtn_momo', { 'data-icon': 'bi-phone' }]
                      ],
                      selected: params[:payment_method]
                    ),
                    { include_blank: false },
                    class: 'form-select form-select-lg',
                    required: true %>
              </div>

              <div class="mb-4">
                <%= f.label :phone_number, 'Recipient Number', class: 'form-label fw-bold' %>
                <div class="input-group">
                  <span class="input-group-text bg-light">+237</span>
                  <%= f.telephone_field :phone_number,
                      class: 'form-control form-control-lg',
                      required: true,
                      placeholder: '6XXXXXXXX',
                      pattern: '^[6-9]\d{8}$',
                      title: 'Enter 9-digit mobile money number' %>
                </div>
                <div class="invalid-feedback">
                  Please enter a valid mobile money number
                </div>
              </div>

              <div class="d-grid">
                <button type="button" class="btn btn-warning btn-lg py-3 fw-bold" data-bs-toggle="modal" data-bs-target="#confirmationModal">
                  <i class="bi bi-shield-check me-2"></i>Review Withdrawal
                </button>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <small class="text-muted me-auto">
          <i class="bi bi-shield-lock me-1"></i>Secure transaction processing
        </small>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i>Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmationModalLabel">
          <i class="bi bi-shield-check me-2"></i> Confirm Withdrawal
        </h5>
      </div>

      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="bi bi-currency-exchange text-primary" style="font-size: 3rem;"></i>
          <h4 class="my-3">Review Your Withdrawal</h4>
        </div>

        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Amount:</span>
              <strong id="modalAmount">0 XAF</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Fee (1%):</span>
              <strong id="modalFee">0 XAF</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total Deduction:</span>
              <span id="modalTotal">0 XAF</span>
            </div>
          </div>
        </div>

        <div class="alert alert-light">
          <div class="d-flex justify-content-between">
            <span>New Balance:</span>
            <strong id="modalNewBalance"><%= number_to_currency(@wallet.balance, unit: 'XAF') %></strong>
          </div>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="confirmWithdrawal" required>
          <label class="form-check-label" for="confirmWithdrawal">
            I confirm this withdrawal request
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-1"></i> Go Back
        </button>
        <button type="button" class="btn btn-primary" id="confirmWithdrawalBtn" disabled>
          <i class="bi bi-check-circle me-1"></i> Confirm & Submit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for enhanced functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Form validation
  const forms = document.querySelectorAll('.needs-validation');
  forms.forEach(form => {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // Withdrawal amount calculations
  const withdrawalAmount = document.getElementById('withdrawalAmount');
  if (withdrawalAmount) {
    withdrawalAmount.addEventListener('input', updateWithdrawalSummary);
  }

  // Confirmation checkbox
  const confirmCheckbox = document.getElementById('confirmWithdrawal');
  if (confirmCheckbox) {
    confirmCheckbox.addEventListener('change', function() {
      document.getElementById('confirmWithdrawalBtn').disabled = !this.checked;
    });
  }

  // Confirm withdrawal button
  const confirmBtn = document.getElementById('confirmWithdrawalBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function() {
      document.getElementById('withdrawalForm').submit();
    });
  }

  function updateWithdrawalSummary() {
    const amount = parseFloat(withdrawalAmount.value) || 0;
    const balance = parseFloat('<%= @wallet.balance %>');
    const fee = Math.max(100, amount * 0.01); // 1% fee with 100 XAF minimum
    const total = amount + fee;

    // Update modal display
    document.getElementById('modalAmount').textContent =
      amount.toLocaleString('en-US', { style: 'currency', currency: 'XAF', minimumFractionDigits: 0 });

    document.getElementById('modalFee').textContent =
      fee.toLocaleString('en-US', { style: 'currency', currency: 'XAF', minimumFractionDigits: 0 });

    document.getElementById('modalTotal').textContent =
      total.toLocaleString('en-US', { style: 'currency', currency: 'XAF', minimumFractionDigits: 0 });

    document.getElementById('modalNewBalance').textContent =
      (balance - total).toLocaleString('en-US', { style: 'currency', currency: 'XAF', minimumFractionDigits: 0 });
  }

  // Initialize withdrawal summary
  if (withdrawalAmount) {
    updateWithdrawalSummary();
  }
});
</script>

<style>
/* Custom modal styles */
.modal-content {
  border-radius: 12px;
  overflow: hidden;
}

.modal-header {
  padding: 1.25rem 1.5rem;
}

.modal-body {
  padding: 1.5rem;
}

/* Input group styling */
.input-group-text {
  min-width: 80px;
}

/* Form validation */
.was-validated .form-control:valid,
.was-validated .form-control:invalid {
  background-position: right 1rem center;
  padding-right: 2.5rem;
}

.was-validated .form-control:valid {
  border-color: #198754;
}

.was-validated .form-control:invalid {
  border-color: #dc3545;
}

/* Spinning icon for processing */
.spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
